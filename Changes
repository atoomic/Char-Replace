Revision history for Char-Replace

{{$NEXT}}

- Fix: UTF-8 safety for trim/trim_inplace with custom charset — bytes
  >= 0x80 are now excluded from trimming to prevent corruption of
  multi-byte sequences (e.g. trimming "é" no longer damages "ã" which
  shares lead byte 0xC3)
- New: compile_map($map) — precompute 256-byte lookup table for repeated
  map use; avoids per-call map analysis overhead in tight loops
- New: replace_list(\@strings, $map) — batch replacement across arrays
  (map analysed once, fast path shared across all elements)
- New: custom trim characters — trim($str, $chars) and
  trim_inplace($str, $chars) accept optional charset parameter
- Fix: use SvROK() instead of SvTYPE()==SVt_RV for reference checks
  (fixes incorrect handling of weakened references)
- Fix: accept non-string defined values via SvOK && !SvROK input
  coercion (integers, floats now auto-stringify instead of silent no-op)
- Perf: PERL_NO_GET_CONTEXT + pTHX_ calling convention for thread
  optimization (no per-call interpreter lookup)
- Perf: DRY refactoring of fast-path helpers (_apply_fast_map,
  _apply_fast_map_inplace) shared by replace, replace_inplace,
  replace_list, and compile_map
- Build: add ppport.h v3.73 for portable backward compat (croak_sv
  fallback for Perl < 5.18)
- Build: remove redundant embed.h include (avoids macro redefinition
  warnings on Perl 5.42+)
- C89 portability: replace // comments with /* */, fix mixed
  declarations
- Test: thread safety tests (4 threads × 200 iterations per function)
- Test: stress tests (74 assertions), taint coverage, guard clause
  coverage, edge cases
- Docs: improve DESCRIPTION, fix POD omissions (vertical tab, identity_map
  example), remove stale alpha warning and outdated Todo

0.007     2026-02-10 11:42:03-07:00 America/Denver

- New: code ref (callback) map entries for dynamic replacement in replace()
  — callback receives the character, return value becomes the replacement
  — return undef to keep original, empty string to delete
  — replace_inplace() croaks on code ref entries (use replace() instead)
- Fix: memory leak when a code ref callback dies during replace()
  (reply SV was not freed on exception; now uses G_EVAL + croak_sv)
- Fix taint propagation: replace() and trim() now correctly propagate the
  taint flag from input to output (previously laundered tainted data)
- New trim_inplace(): zero-allocation in-place whitespace trimming
  (modifies string directly, returns count of bytes removed)
- UTF-8 safety: multi-byte sequences (>= 0x80) are now copied through
  unchanged; replacement map is only applied to ASCII bytes (0x00-0x7F)
- IV/NV map entries: integer values treated as character ordinals (chr)
- Empty string map entries now delete the character from output
- Fix off-by-one: map[255] is now reachable (>= vs > boundary)
- Fix type safety: unsigned char for byte handling, STRLEN for loop vars
- New replace_inplace(): zero-allocation in-place 1:1 byte replacement
  (up to 3.5x faster than replace() for long strings)
- New build_map(): convenience constructor from char => replacement pairs
- Perf: replace() writes directly into SV buffer (avoids temp alloc+copy)
- Perf: precomputed 256-byte lookup table fast path for 1:1 maps in both
  replace() and replace_inplace() — eliminates per-byte SV type dispatch;
  replace() on long strings is now faster than Perl's tr///
- Refactor: extract UTF8_SEQ_LEN macro for shared UTF-8 byte handling

0.006     2025-11-21 16:07:16-07:00 America/Denver

- Fix compiling issue with threaded Perl versions
- Fix compiling warnings

0.005     2025-05-18 15:27:02-06:00 America/Denver

- Fix compiler error due to incorrect pointer type in Newx cal

0.004     2019-01-30 13:04:14-06:00 America/Chicago

- fix issue when growing a string containing a '\0'

0.003     2018-12-14 15:30:08-06:00 America/Chicago

- add a trim XS helper (and some benchmark) with UTF-8 support
- basic UTF-8 support for replace

0.002     2018-12-11 14:55:47-06:00 America/Chicago

- fixup for non alphanumeric characters

0.001     2018-12-11 12:03:27-06:00 America/Chicago

First version, this is a very alpha state
    use it at your own risk

